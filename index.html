<!DOCTYPE html>
<html>
<head>
  <title>Interaktive Dune Karte</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    #map {
      position: absolute;
      top: 0; left: 0;
      right: 250px;
      bottom: 0;
    }
    #sidebar {
      position: absolute;
      top: 0;
      right: 0;
      width: 250px;
      height: 100%;
      background: #f4f4f4;
      border-left: 1px solid #ccc;
      overflow-y: auto;
      padding: 10px;
      font-family: sans-serif;
      box-sizing: border-box;
      z-index: 1000;
    }
    #sidebar h2 {
      font-size: 1.2em;
      margin-top: 0;
    }
    #sidebar ul {
      list-style: none;
      padding-left: 0;
    }
    #sidebar li {
      margin-bottom: 5px;
    }
    #sidebar label {
      cursor: pointer;
    }
    #coords {
      position: absolute;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-family: monospace;
      z-index: 1001;
    }
    button {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      background-color: #0077cc;
      color: white;
      border: none;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background-color: #005fa3;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <button onclick="openMarkerForm()">➕ New Marker</button>
    <h2>Marker Übersicht</h2>
    <ul id="markerList"></ul>
  </div>
  <div id="coords">X: –, Y: –</div>

  <script>
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -1,
      maxZoom: 4
    });

    const bounds = [[0, 0], [1024, 1024]];
    L.imageOverlay('map.png', bounds).addTo(map);
    map.fitBounds(bounds);

    map.on('mousemove', function (e) {
      document.getElementById('coords').textContent =
        `X: ${e.latlng.lng.toFixed(1)}, Y: ${e.latlng.lat.toFixed(1)}`;
    });

    const markerList = document.getElementById('markerList');
    const markers = [];

    const icon = L.divIcon({
      className: '',
      html: `<svg width="20" height="20" viewBox="0 0 20 20">
        <circle cx="10" cy="10" r="8" fill="red" stroke="black" stroke-width="1" />
      </svg>`,
      iconSize: [20, 20],
      iconAnchor: [10, 10]
    });

    fetch('markers.json')
      .then(r => r.json())
      .then(data => {
        data.forEach((m, i) => {
          const latlng = [m.coords[1], m.coords[0]];
          const marker = L.marker(latlng, { icon }).bindPopup(
            `<strong>${m.name}</strong><br>${m.description}<br><em>X: ${m.coords[0]}, Y: ${m.coords[1]}</em>`
          ).addTo(map);
          markers.push(marker);

          const li = document.createElement('li');
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = true;
          cb.id = 'marker-' + i;
          cb.addEventListener('change', () => {
            if (cb.checked) map.addLayer(marker);
            else map.removeLayer(marker);
          });

          const label = document.createElement('label');
          label.htmlFor = cb.id;
          label.textContent = m.name;

          li.appendChild(cb);
          li.appendChild(label);
          markerList.appendChild(li);
        });
      });

    function openMarkerForm() {
      const formHtml = `
        <form id="newMarkerForm">
          <p><strong>Marker vorschlagen</strong></p>
          <label>Name:<br><input name="name" required /></label><br>
          <label>Beschreibung:<br><textarea name="description" required></textarea></label><br>
          <label>X:<br><input name="x" type="number" required /></label><br>
          <label>Y:<br><input name="y" type="number" required /></label><br><br>
          <button type="submit">Abschicken</button>
        </form>
      `;
      const popup = L.popup()
        .setLatLng(map.getCenter())
        .setContent(formHtml)
        .openOn(map);

      document.getElementById('newMarkerForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const form = e.target;
        const data = {
          name: form.name.value,
          description: form.description.value,
          coords: [parseFloat(form.x.value), parseFloat(form.y.value)]
        };
        try {
          await fetch('https://federkinder.vercel.app/api/submitMarker', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });
          alert('Marker-Vorschlag gesendet!');
          map.closePopup();
        } catch (err) {
          alert('Fehler beim Senden!');
        }
      });
    }
  </script>
</body>
</html>
